-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- RAYFIELD
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
   Name = "Rezix Hub",
   Icon = 0, -- Icon in Topbar. Can use Lucide Icons (string) or Roblox Image (number). 0 to use no icon (default).
   LoadingTitle = "Loading...",
   LoadingSubtitle = "by Rezix",
   ShowText = "Rayfield", -- for mobile users to unhide rayfield, change if you'd like
   Theme = "Default", -- Check https://docs.sirius.menu/rayfield/configuration/themes

   ToggleUIKeybind = "K", -- The keybind to toggle the UI visibility (string like "K" or Enum.KeyCode)

   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false, -- Prevents Rayfield from warning when the script has a version mismatch with the interface

   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil, -- Create a custom folder for your hub/game
      FileName = "Rezix Hub"
   },

   Discord = {
      Enabled = true, -- Prompt the user to join your Discord server if their executor supports it
      Invite = "NtNpcQpdwQ", -- The Discord invite code, do not include discord.gg/. E.g. discord.gg/ ABCD would be ABCD
      RememberJoins = true -- Set this to false to make them join the discord every time they load it up
   },
 KeySystem = true, -- Set this to true to use our key system
 KeySettings = {
      Title = "Get Key From Discord",
      Subtitle = "Key System",
      Note = "Join Discord To Get Key dc.gg/rezixhub", -- Use this to tell the user how to get a key
      FileName = "Key", -- It is recommended to use something unique as other scripts using Rayfield may overwrite your key file
      SaveKey = true, -- The user's key will be saved, but if you change the key, they will be unable to use your script
      GrabKeyFromSite = true, -- If this is true, set Key below to the RAW site you would like Rayfield to get the key from
      Key = "https://pastebin.com/raw/1XHnWdLp"
      
}
})

local CombatTab = Window:CreateTab("Combat", 4483362458)
local VisualTab = Window:CreateTab("Visuals", 4483362458)

-- SETTINGS
local Settings = {
	AimbotEnabled = false,
	AimbotKey = Enum.UserInputType.MouseButton2,

	FOV = 150,
	FOVColor = Color3.fromRGB(255,0,0),
	FOVRainbow = false,

	ESPColor = Color3.fromRGB(255,170,60),
	ESPRainbow = false,

	MaxDistance = 500,
	SmoothingFactor = 1,
	HealthBarBG = Color3.fromRGB(40,40,40)
}

local State = {TrackedCharacters = {}}

-- UI CONTROLS
CombatTab:CreateToggle({
	Name = "Aimbot (Hold RMB)",
	CurrentValue = false,
	Callback = function(v)
		Settings.AimbotEnabled = v
	end
})

VisualTab:CreateSlider({
	Name = "FOV Size",
	Range = {50, 500},
	Increment = 5,
	CurrentValue = Settings.FOV,
	Callback = function(v)
		Settings.FOV = v
	end
})

VisualTab:CreateColorPicker({
	Name = "FOV Color",
	Color = Settings.FOVColor,
	Callback = function(v)
		Settings.FOVColor = v
	end
})

VisualTab:CreateToggle({
	Name = "Rainbow FOV",
	CurrentValue = false,
	Callback = function(v)
		Settings.FOVRainbow = v
	end
})

VisualTab:CreateColorPicker({
	Name = "ESP Color",
	Color = Settings.ESPColor,
	Callback = function(v)
		Settings.ESPColor = v
	end
})

VisualTab:CreateToggle({
	Name = "Rainbow ESP",
	CurrentValue = false,
	Callback = function(v)
		Settings.ESPRainbow = v
	end
})

-- FOV CIRCLE
local FOVCircle = Drawing.new("Circle")
FOVCircle.Filled = false
FOVCircle.Thickness = 2
FOVCircle.Visible = true

-- ESP CREATION
local function makeESP(char)
	if State.TrackedCharacters[char] then return end
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hrp or not hum then return end

	local folder = Instance.new("Folder", char)
	folder.Name = "ESPVisual"

	local highlight = Instance.new("Highlight", folder)
	highlight.Adornee = char
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop

	-- HEALTH BAR
	local billboard = Instance.new("BillboardGui", folder)
	billboard.Adornee = hrp
	billboard.Size = UDim2.new(0, 6, 0, 50)
	billboard.StudsOffset = Vector3.new(-2.5, 0, 0)
	billboard.AlwaysOnTop = true

	local bg = Instance.new("Frame", billboard)
	bg.Size = UDim2.new(1,0,1,0)
	bg.BackgroundColor3 = Settings.HealthBarBG
	bg.BorderSizePixel = 0

	local bar = Instance.new("Frame", bg)
	bar.AnchorPoint = Vector2.new(0,1)
	bar.Position = UDim2.new(0,0,1,0)
	bar.Size = UDim2.new(1,0,1,0)
	bar.BorderSizePixel = 0

	State.TrackedCharacters[char] = {
		Highlight = highlight,
		HealthBar = bar,
		Humanoid = hum
	}
end

local function removeESP(char)
	local d = State.TrackedCharacters[char]
	if d then
		if d.Highlight then d.Highlight.Parent:Destroy() end
		State.TrackedCharacters[char] = nil
	end
end

-- TARGET FINDER
local function getTarget()
	local best, bestDist = nil, math.huge
	local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
	local localChar = LocalPlayer.Character
	if not localChar or not localChar:FindFirstChild("HumanoidRootPart") then return end

	for _,p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local hum = p.Character:FindFirstChildOfClass("Humanoid")
			if hum and hum.Health > 0 then
				local pos, onScreen = Camera:WorldToScreenPoint(p.Character.HumanoidRootPart.Position)
				if onScreen then
					local dist = (Vector2.new(pos.X,pos.Y) - center).Magnitude
					if dist < Settings.FOV and dist < bestDist then
						bestDist = dist
						best = p.Character
					end
				end
			end
		end
	end
	return best
end

-- AIM
local function aimAt(target)
	if not target then return end
	local head = target:FindFirstChild("Head")
	if not head then return end
	Camera.CFrame = Camera.CFrame:Lerp(
		CFrame.new(Camera.CFrame.Position, head.Position),
		1 / Settings.SmoothingFactor
	)
end

-- PLAYER TRACKING
local function track(plr)
	if plr == LocalPlayer then return end
	plr.CharacterAdded:Connect(function(char)
		task.wait(0.1)
		makeESP(char)
	end)
	plr.CharacterRemoving:Connect(removeESP)
	if plr.Character then makeESP(plr.Character) end
end

for _,p in pairs(Players:GetPlayers()) do track(p) end
Players.PlayerAdded:Connect(track)

-- RENDER LOOP
RunService.RenderStepped:Connect(function()
	local hue = (tick() % 5) / 5
	local rainbow = Color3.fromHSV(hue,1,1)

	FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
	FOVCircle.Radius = Settings.FOV
	FOVCircle.Color = Settings.FOVRainbow and rainbow or Settings.FOVColor

	local target = getTarget()

	if Settings.AimbotEnabled and UserInputService:IsMouseButtonPressed(Settings.AimbotKey) then
		aimAt(target)
	end

	for char,data in pairs(State.TrackedCharacters) do
		if data.Humanoid.Health <= 0 then
			removeESP(char)
		else
			local hpPercent = data.Humanoid.Health / data.Humanoid.MaxHealth
			data.HealthBar.Size = UDim2.new(1,0,hpPercent,0)
			data.HealthBar.BackgroundColor3 =
				Color3.fromRGB(255,0,0):Lerp(Color3.fromRGB(0,255,0), hpPercent)

			local espColor = Settings.ESPRainbow and rainbow or Settings.ESPColor
			data.Highlight.FillColor = espColor
			data.Highlight.OutlineColor = espColor
		end
	end
end)
